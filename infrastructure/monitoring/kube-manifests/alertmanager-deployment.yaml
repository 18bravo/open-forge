# Alertmanager Deployment for Open Forge
# This deploys Alertmanager for alert routing and notification

---
# Secret for Alertmanager configuration
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-main
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/part-of: open-forge
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      receiver: 'default-receiver'
      group_by: ['alertname', 'service', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      routes:
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 10s
          repeat_interval: 1h
        - match:
            severity: warning
          receiver: 'warning-alerts'
          group_wait: 1m
          repeat_interval: 4h

    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'service', 'namespace']

    receivers:
      - name: 'default-receiver'
        webhook_configs:
          - url: 'http://localhost:5001/'
            send_resolved: true

      - name: 'critical-alerts'
        webhook_configs:
          - url: 'http://localhost:5001/'
            send_resolved: true

      - name: 'warning-alerts'
        webhook_configs:
          - url: 'http://localhost:5001/'
            send_resolved: true

---
# Secret for notification credentials
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-secrets
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
type: Opaque
stringData:
  slack-webhook-url: "https://hooks.slack.com/services/CHANGE_ME"
  pagerduty-service-key: "CHANGE_ME"
  pagerduty-infra-key: "CHANGE_ME"
  pagerduty-backend-key: "CHANGE_ME"
  pagerduty-ml-key: "CHANGE_ME"
  pagerduty-data-key: "CHANGE_ME"
  pagerduty-security-key: "CHANGE_ME"
  smtp-password: "CHANGE_ME"

---
# Alertmanager Custom Resource (for Prometheus Operator)
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  name: main
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
    app.kubernetes.io/instance: main
    app.kubernetes.io/part-of: open-forge
spec:
  # Version and image
  version: v0.26.0
  image: quay.io/prometheus/alertmanager:v0.26.0

  # Replicas for HA (must be odd number for proper quorum)
  replicas: 3

  # Resource requirements
  resources:
    requests:
      cpu: 50m
      memory: 100Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Storage configuration
  storage:
    volumeClaimTemplate:
      spec:
        storageClassName: standard
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 5Gi

  # Security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  # Config secret
  configSecret: alertmanager-main

  # External URL for links in notifications
  externalUrl: https://alertmanager.open-forge.io

  # Route prefix
  routePrefix: /

  # Log level
  logLevel: info

  # Log format
  logFormat: logfmt

  # Retention
  retention: 120h

  # Pod metadata
  podMetadata:
    labels:
      app.kubernetes.io/name: alertmanager
      app.kubernetes.io/instance: main
    annotations:
      cluster-autoscaler.kubernetes.io/safe-to-evict: "true"

  # Affinity for spreading replicas
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: alertmanager
                app.kubernetes.io/instance: main
            topologyKey: kubernetes.io/hostname

  # Node selector
  nodeSelector:
    kubernetes.io/os: linux

  # Tolerations
  tolerations:
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

  # Additional volumes for secrets
  volumes:
    - name: alertmanager-secrets
      secret:
        secretName: alertmanager-secrets

  volumeMounts:
    - name: alertmanager-secrets
      mountPath: /etc/alertmanager/secrets
      readOnly: true

---
# Service for Alertmanager
apiVersion: v1
kind: Service
metadata:
  name: alertmanager-main
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
    alertmanager: main
spec:
  ports:
    - name: web
      port: 9093
      targetPort: web
    - name: reloader-web
      port: 8080
      targetPort: reloader-web
    - name: mesh-tcp
      port: 9094
      targetPort: mesh-tcp
    - name: mesh-udp
      port: 9094
      targetPort: mesh-udp
      protocol: UDP
  selector:
    app.kubernetes.io/name: alertmanager
    alertmanager: main
  sessionAffinity: ClientIP

---
# Headless Service for Alertmanager mesh
apiVersion: v1
kind: Service
metadata:
  name: alertmanager-operated
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
    operated-alertmanager: "true"
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - name: web
      port: 9093
      targetPort: web
    - name: mesh-tcp
      port: 9094
      targetPort: mesh-tcp
    - name: mesh-udp
      port: 9094
      targetPort: mesh-udp
      protocol: UDP
  selector:
    app.kubernetes.io/name: alertmanager

---
# Ingress for Alertmanager
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: alertmanager
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
  annotations:
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: alertmanager-basic-auth
    nginx.ingress.kubernetes.io/auth-realm: "Alertmanager Authentication"
spec:
  ingressClassName: nginx
  rules:
    - host: alertmanager.open-forge.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: alertmanager-main
                port:
                  number: 9093
  tls:
    - hosts:
        - alertmanager.open-forge.io
      secretName: alertmanager-tls

---
# NetworkPolicy for Alertmanager
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: alertmanager
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: alertmanager
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - port: 9093
          protocol: TCP
    # Allow Prometheus
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: prometheus
      ports:
        - port: 9093
          protocol: TCP
    # Allow Grafana
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - port: 9093
          protocol: TCP
    # Allow mesh communication
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: alertmanager
      ports:
        - port: 9094
          protocol: TCP
        - port: 9094
          protocol: UDP
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - port: 53
          protocol: UDP
        - port: 53
          protocol: TCP
    # Allow mesh communication
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: alertmanager
      ports:
        - port: 9094
          protocol: TCP
        - port: 9094
          protocol: UDP
    # Allow outbound notifications (SMTP, webhooks, etc.)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - port: 443
          protocol: TCP
        - port: 587
          protocol: TCP

---
# PrometheusRule for Alertmanager self-monitoring
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: alertmanager-self-monitoring
  namespace: open-forge
  labels:
    app.kubernetes.io/name: alertmanager
    prometheus: main
    role: alert-rules
spec:
  groups:
    - name: alertmanager
      rules:
        - alert: AlertmanagerConfigInconsistent
          expr: |
            count by (namespace, service) (
              count_values by (namespace, service) ("config_hash", alertmanager_config_hash)
            ) != 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Alertmanager configuration is inconsistent"
            description: "The Alertmanager instances have inconsistent configuration."

        - alert: AlertmanagerClusterDown
          expr: |
            (
              count(alertmanager_cluster_members) by (namespace, service)
              - on (namespace, service) group_left
              count(up{job="alertmanager"} == 1) by (namespace, service)
            ) != 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Alertmanager cluster is partially down"
            description: "Some Alertmanager cluster members are down."

        - alert: AlertmanagerClusterCrashlooping
          expr: |
            count by (namespace, service) (
              changes(process_start_time_seconds{job="alertmanager"}[10m]) > 4
            )
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Alertmanager cluster is crash looping"
            description: "Alertmanager instances are restarting frequently."

        - alert: AlertmanagerFailedReload
          expr: alertmanager_config_last_reload_successful != 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Alertmanager configuration reload failed"
            description: "Alertmanager failed to reload its configuration."

        - alert: AlertmanagerNotificationsFailed
          expr: |
            rate(alertmanager_notifications_failed_total[5m]) > 0
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Alertmanager notifications are failing"
            description: "Alertmanager is failing to send notifications for {{ $labels.integration }}."
