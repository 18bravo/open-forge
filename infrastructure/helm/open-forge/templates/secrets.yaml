{{- if not .Values.secrets.existingSecret }}
{{- if .Values.secrets.externalSecrets.enabled }}
# External Secrets for production use
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "open-forge.secretsName" . }}
  labels:
    {{- include "open-forge.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ .Values.secrets.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: {{ .Values.secrets.externalSecrets.secretStoreRef.kind }}
    name: {{ .Values.secrets.externalSecrets.secretStoreRef.name }}
  target:
    name: {{ include "open-forge.secretsName" . }}
    creationPolicy: Owner
  data:
    - secretKey: database-url
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/database
        property: url
    - secretKey: redis-url
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/redis
        property: url
    - secretKey: jwt-secret
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/auth
        property: jwt-secret
    - secretKey: nextauth-secret
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/auth
        property: nextauth-secret
    - secretKey: openai-api-key
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/ai
        property: openai-api-key
    - secretKey: anthropic-api-key
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/ai
        property: anthropic-api-key
    - secretKey: minio-access-key
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/minio
        property: access-key
    - secretKey: minio-secret-key
      remoteRef:
        key: {{ .Values.secrets.externalSecrets.keyPrefix }}/minio
        property: secret-key
{{- else }}
# Static Secrets - Use External Secrets or Sealed Secrets in production
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "open-forge.secretsName" . }}
  labels:
    {{- include "open-forge.labels" . | nindent 4 }}
  annotations:
    description: "Template secret - replace with ExternalSecret in production"
    {{- with .Values.commonAnnotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
type: Opaque
stringData:
  # Database URLs
  {{- $postgresHost := include "open-forge.postgresql.host" . }}
  {{- $postgresUser := .Values.postgresql.auth.username | default "openforge" }}
  {{- $postgresPassword := .Values.postgresql.auth.password | default "CHANGE_ME" }}
  {{- $postgresDB := .Values.postgresql.auth.database | default "openforge" }}
  database-url: "postgresql://{{ $postgresUser }}:{{ $postgresPassword }}@{{ $postgresHost }}:5432/{{ $postgresDB }}"

  {{- $redisHost := include "open-forge.redis.host" . }}
  redis-url: "redis://{{ $redisHost }}:6379/0"

  # JWT and Auth
  jwt-secret: {{ .Values.secrets.values.jwtSecret | default "CHANGE_ME_IN_PRODUCTION_USE_32_CHARS_MIN" | quote }}
  nextauth-secret: {{ .Values.secrets.values.nextauthSecret | default "CHANGE_ME_IN_PRODUCTION_USE_32_CHARS_MIN" | quote }}

  # AI Provider API Keys (optional)
  openai-api-key: {{ .Values.secrets.values.openaiApiKey | default "" | quote }}
  anthropic-api-key: {{ .Values.secrets.values.anthropicApiKey | default "" | quote }}

  # MinIO Credentials
  minio-access-key: {{ .Values.minio.auth.rootUser | default "minio" | quote }}
  minio-secret-key: {{ .Values.minio.auth.rootPassword | default "CHANGE_ME_IN_PRODUCTION" | quote }}
{{- end }}
{{- end }}
