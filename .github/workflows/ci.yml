# =============================================================================
# CI Workflow for Open Forge
# =============================================================================
# This workflow runs on all pull requests to main and performs:
# - Python linting with ruff
# - Python type checking with mypy
# - Python tests with pytest (unit and integration)
# - TypeScript/React linting with eslint
# - TypeScript tests with vitest
# - Code coverage reporting
# =============================================================================

name: CI

on:
  pull_request:
    branches:
      - main
    paths:
      - 'packages/**'
      - 'tests/**'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'

  # Allow manual trigger
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  COVERAGE_THRESHOLD: 70

jobs:
  # ===========================================================================
  # Python Linting with Ruff
  # ===========================================================================
  python-lint:
    name: Python Lint (Ruff)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff linter
        run: ruff check packages/ tests/

      - name: Run ruff formatter check
        run: ruff format --check packages/ tests/

  # ===========================================================================
  # Python Type Checking with MyPy
  # ===========================================================================
  python-typecheck:
    name: Python Type Check (MyPy)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-typecheck-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-typecheck-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"
          pip install mypy

      - name: Run mypy
        run: |
          mypy packages/core/src \
               packages/agent-framework/src \
               packages/ontology/src \
               packages/connectors/src \
               packages/agents/src \
               packages/pipelines/src \
               packages/api/src \
               --ignore-missing-imports

  # ===========================================================================
  # Python Unit Tests with Pytest
  # ===========================================================================
  python-unit-tests:
    name: Python Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        package:
          - core
          - agent-framework
          - ontology
          - connectors
          - agents
          - pipelines
          - api
          - mcp-server
          - langflow-components

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-test-${{ matrix.package }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-test-${{ matrix.package }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run pytest for ${{ matrix.package }}
        run: |
          pytest packages/${{ matrix.package }}/tests \
            --cov=packages/${{ matrix.package }}/src \
            --cov-report=xml:coverage-${{ matrix.package }}.xml \
            --cov-report=term-missing \
            --junitxml=junit-${{ matrix.package }}.xml \
            -v
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.package }}
          path: coverage-${{ matrix.package }}.xml
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit-${{ matrix.package }}
          path: junit-${{ matrix.package }}.xml
          retention-days: 7

  # ===========================================================================
  # Python Integration Tests
  # ===========================================================================
  python-integration-tests:
    name: Python Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [python-lint, python-typecheck]

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: foundry
          POSTGRES_PASSWORD: foundry_test
          POSTGRES_DB: foundry_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://foundry:foundry_test@localhost:5432/foundry_test
      REDIS_URL: redis://localhost:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-integration-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-integration-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Wait for services
        run: |
          sleep 5

      - name: Run integration tests
        run: |
          pytest tests/integration \
            --cov=packages \
            --cov-report=xml:coverage-integration.xml \
            --cov-report=term-missing \
            --junitxml=junit-integration.xml \
            -v -m "not e2e"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration
          path: coverage-integration.xml
          retention-days: 7

  # ===========================================================================
  # TypeScript/React Linting with ESLint
  # ===========================================================================
  typescript-lint:
    name: TypeScript Lint (ESLint)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Install dependencies
        working-directory: packages/ui
        run: npm ci

      - name: Run ESLint
        working-directory: packages/ui
        run: npm run lint

      - name: Run TypeScript type check
        working-directory: packages/ui
        run: npm run type-check

  # ===========================================================================
  # TypeScript Tests with Vitest
  # ===========================================================================
  typescript-tests:
    name: TypeScript Tests (Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: packages/ui/package-lock.json

      - name: Install dependencies
        working-directory: packages/ui
        run: npm ci

      - name: Run Vitest
        working-directory: packages/ui
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ui
          path: packages/ui/coverage
          retention-days: 7

  # ===========================================================================
  # Code Coverage Report
  # ===========================================================================
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs:
      - python-unit-tests
      - python-integration-tests
      - typescript-tests
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports
          pattern: coverage-*

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: coverage-reports
          fail_ci_if_error: false
          verbose: true

      - name: Comment on PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find coverage files and generate summary
            let summary = '## Coverage Report\n\n';
            summary += '| Package | Coverage |\n';
            summary += '|---------|----------|\n';

            const coverageDir = 'coverage-reports';
            if (fs.existsSync(coverageDir)) {
              const dirs = fs.readdirSync(coverageDir);
              for (const dir of dirs) {
                summary += `| ${dir.replace('coverage-', '')} | See Codecov |\n`;
              }
            }

            summary += '\n*Full coverage details available on Codecov*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # ===========================================================================
  # CI Status Check
  # ===========================================================================
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs:
      - python-lint
      - python-typecheck
      - python-unit-tests
      - python-integration-tests
      - typescript-lint
      - typescript-tests
    if: always()

    steps:
      - name: Check CI status
        run: |
          if [[ "${{ needs.python-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.python-typecheck.result }}" == "failure" ]] || \
             [[ "${{ needs.python-unit-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.python-integration-tests.result }}" == "failure" ]] || \
             [[ "${{ needs.typescript-lint.result }}" == "failure" ]] || \
             [[ "${{ needs.typescript-tests.result }}" == "failure" ]]; then
            echo "CI failed"
            exit 1
          fi
          echo "CI passed"
