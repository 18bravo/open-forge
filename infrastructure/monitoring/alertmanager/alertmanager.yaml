# Alertmanager Configuration for Open Forge
# This configuration handles routing, grouping, and notification of alerts

global:
  # Global settings applied to all routes
  resolve_timeout: 5m

  # SMTP settings for email notifications
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@open-forge.io'
  smtp_auth_username: 'alertmanager@open-forge.io'
  smtp_auth_password_file: '/etc/alertmanager/secrets/smtp-password'
  smtp_require_tls: true

  # Slack API URL (use secrets in production)
  slack_api_url_file: '/etc/alertmanager/secrets/slack-webhook-url'

  # PagerDuty integration
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

  # OpsGenie integration (optional)
  # opsgenie_api_url: 'https://api.opsgenie.com/'
  # opsgenie_api_key_file: '/etc/alertmanager/secrets/opsgenie-api-key'

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alert routing
route:
  # Default receiver
  receiver: 'default-receiver'

  # Group alerts by these labels
  group_by: ['alertname', 'service', 'namespace']

  # Wait time before sending first notification
  group_wait: 30s

  # Wait time before sending updated notification
  group_interval: 5m

  # Minimum time between repeated notifications
  repeat_interval: 4h

  # Child routes (evaluated in order, first match wins)
  routes:
    # Critical alerts - immediate PagerDuty + Slack
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 1h
      continue: false

    # Warning alerts - Slack notification
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 4h
      continue: false

    # Infrastructure team routing
    - match:
        team: infrastructure
      receiver: 'infrastructure-team'
      routes:
        - match:
            severity: critical
          receiver: 'infrastructure-critical'
          group_wait: 10s
          repeat_interval: 1h

    # Backend team routing
    - match:
        team: backend
      receiver: 'backend-team'
      routes:
        - match:
            severity: critical
          receiver: 'backend-critical'
          group_wait: 10s
          repeat_interval: 1h

    # ML/Agent team routing
    - match:
        team: ml
      receiver: 'ml-team'
      routes:
        - match:
            severity: critical
          receiver: 'ml-critical'
          group_wait: 10s
          repeat_interval: 1h

    # Data team routing (pipelines)
    - match:
        team: data
      receiver: 'data-team'
      routes:
        - match:
            severity: critical
          receiver: 'data-critical'
          group_wait: 10s
          repeat_interval: 1h

    # Security alerts
    - match:
        team: security
      receiver: 'security-team'
      group_wait: 10s
      repeat_interval: 30m
      continue: false

    # Info-level alerts - just log/low-priority channel
    - match:
        severity: info
      receiver: 'info-alerts'
      group_wait: 5m
      group_interval: 15m
      repeat_interval: 24h

# Inhibition rules - suppress lower severity alerts when higher severity fires
inhibit_rules:
  # If critical fires, suppress warning for same alert
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'namespace']

  # If service is down, suppress all other alerts for that service
  - source_match:
      alertname: 'APIServiceDown'
    target_match_re:
      alertname: 'API.*'
    equal: ['namespace']

  - source_match:
      alertname: 'DagsterDaemonDown'
    target_match_re:
      alertname: 'Pipeline.*|Sensor.*|Asset.*'
    equal: ['namespace']

  - source_match:
      alertname: 'PostgreSQLDown'
    target_match_re:
      alertname: 'PostgreSQL.*'
    equal: ['namespace']

  - source_match:
      alertname: 'RedisDown'
    target_match_re:
      alertname: 'Redis.*'
    equal: ['namespace']

  - source_match:
      alertname: 'MinIODown'
    target_match_re:
      alertname: 'MinIO.*'
    equal: ['namespace']

  # Node-level inhibition
  - source_match:
      alertname: 'NodeNotReady'
    target_match_re:
      alertname: 'Node.*|Pod.*'
    equal: ['node']

# Receivers define notification channels
receivers:
  # Default receiver - Slack general channel
  - name: 'default-receiver'
    slack_configs:
      - channel: '#open-forge-alerts'
        send_resolved: true
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
          - type: button
            text: 'Runbook'
            url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
          - type: button
            text: 'Dashboard'
            url: '{{ (index .Alerts 0).Annotations.dashboard_url }}'

  # Critical alerts - PagerDuty + Slack
  - name: 'critical-alerts'
    pagerduty_configs:
      - service_key_file: '/etc/alertmanager/secrets/pagerduty-service-key'
        severity: critical
        description: '{{ .CommonAnnotations.summary }}'
        details:
          alertname: '{{ .CommonLabels.alertname }}'
          service: '{{ .CommonLabels.service }}'
          namespace: '{{ .CommonLabels.namespace }}'
          description: '{{ .CommonAnnotations.description }}'
          runbook: '{{ .CommonAnnotations.runbook_url }}'
    slack_configs:
      - channel: '#open-forge-critical'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: '[CRITICAL] {{ .CommonAnnotations.summary }}'
        text: '{{ template "slack.default.text" . }}'
        actions:
          - type: button
            text: 'Runbook'
            url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
          - type: button
            text: 'Dashboard'
            url: '{{ (index .Alerts 0).Annotations.dashboard_url }}'
    email_configs:
      - to: 'oncall@open-forge.io'
        send_resolved: true
        headers:
          Subject: '[CRITICAL] Open Forge Alert: {{ .CommonAnnotations.summary }}'

  # Warning alerts - Slack only
  - name: 'warning-alerts'
    slack_configs:
      - channel: '#open-forge-alerts'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        title: '[WARNING] {{ .CommonAnnotations.summary }}'
        text: '{{ template "slack.default.text" . }}'

  # Info alerts - Low priority channel
  - name: 'info-alerts'
    slack_configs:
      - channel: '#open-forge-alerts-low'
        send_resolved: false
        color: '{{ if eq .Status "firing" }}#439FE0{{ else }}good{{ end }}'
        title: '[INFO] {{ .CommonAnnotations.summary }}'
        text: '{{ template "slack.default.text" . }}'

  # Infrastructure team
  - name: 'infrastructure-team'
    slack_configs:
      - channel: '#infrastructure-alerts'
        send_resolved: true
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'

  - name: 'infrastructure-critical'
    pagerduty_configs:
      - service_key_file: '/etc/alertmanager/secrets/pagerduty-infra-key'
        severity: critical
    slack_configs:
      - channel: '#infrastructure-critical'
        send_resolved: true
        color: 'danger'
        title: '[CRITICAL] {{ .CommonAnnotations.summary }}'
        text: '{{ template "slack.default.text" . }}'

  # Backend team
  - name: 'backend-team'
    slack_configs:
      - channel: '#backend-alerts'
        send_resolved: true
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'

  - name: 'backend-critical'
    pagerduty_configs:
      - service_key_file: '/etc/alertmanager/secrets/pagerduty-backend-key'
        severity: critical
    slack_configs:
      - channel: '#backend-critical'
        send_resolved: true
        color: 'danger'

  # ML team
  - name: 'ml-team'
    slack_configs:
      - channel: '#ml-alerts'
        send_resolved: true
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'

  - name: 'ml-critical'
    pagerduty_configs:
      - service_key_file: '/etc/alertmanager/secrets/pagerduty-ml-key'
        severity: critical
    slack_configs:
      - channel: '#ml-critical'
        send_resolved: true
        color: 'danger'

  # Data team
  - name: 'data-team'
    slack_configs:
      - channel: '#data-alerts'
        send_resolved: true
        title: '{{ template "slack.default.title" . }}'
        text: '{{ template "slack.default.text" . }}'

  - name: 'data-critical'
    pagerduty_configs:
      - service_key_file: '/etc/alertmanager/secrets/pagerduty-data-key'
        severity: critical
    slack_configs:
      - channel: '#data-critical'
        send_resolved: true
        color: 'danger'

  # Security team
  - name: 'security-team'
    pagerduty_configs:
      - service_key_file: '/etc/alertmanager/secrets/pagerduty-security-key'
        severity: high
    slack_configs:
      - channel: '#security-alerts'
        send_resolved: true
        color: 'danger'
        title: '[SECURITY] {{ .CommonAnnotations.summary }}'
        text: '{{ template "slack.default.text" . }}'
    email_configs:
      - to: 'security@open-forge.io'
        send_resolved: true
