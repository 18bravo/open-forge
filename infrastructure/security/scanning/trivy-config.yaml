# Open Forge Trivy Operator Configuration
# Provides automated vulnerability scanning and configuration auditing
#
# Prerequisites:
#   1. Install Trivy Operator: helm install trivy-operator aqua/trivy-operator -n trivy-system --create-namespace
#   2. Configure image registry credentials if using private registries
#
# Features:
#   - VulnerabilityReports: Scans container images for known vulnerabilities
#   - ConfigAuditReports: Checks Kubernetes resources against security best practices
#   - ExposedSecretReports: Detects secrets exposed in container images
#   - RbacAssessmentReports: Evaluates RBAC configurations
---
# Trivy Operator Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: trivy-system
  labels:
    app.kubernetes.io/name: trivy-operator
    app.kubernetes.io/part-of: open-forge-security
    # Pod Security Standards - Trivy needs elevated permissions
    pod-security.kubernetes.io/enforce: baseline
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
---
# Trivy Operator ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-operator-config
  namespace: trivy-system
  labels:
    app.kubernetes.io/name: trivy-operator
    app.kubernetes.io/component: config
    app.kubernetes.io/part-of: open-forge-security
data:
  # Scanner configuration
  trivy.severity: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
  trivy.slow: "true"
  trivy.skipFiles: ""
  trivy.skipDirs: "/proc,/sys,/dev"
  trivy.offlineScan: "false"
  trivy.timeout: "5m0s"
  # Database configuration
  trivy.dbRepository: "ghcr.io/aquasecurity/trivy-db"
  trivy.dbRepositoryInsecure: "false"
  # Resource limits for scan jobs
  trivy.resources.requests.cpu: "100m"
  trivy.resources.requests.memory: "100Mi"
  trivy.resources.limits.cpu: "500m"
  trivy.resources.limits.memory: "500Mi"
  # Compliance reports
  compliance.failEntriesLimit: "10"
---
# Trivy Operator Policies ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-operator-policies-config
  namespace: trivy-system
  labels:
    app.kubernetes.io/name: trivy-operator
    app.kubernetes.io/component: policies
    app.kubernetes.io/part-of: open-forge-security
data:
  # Built-in policies to enable
  policy.builtin.kubernetes.enabled: "true"
  policy.builtin.appshield.enabled: "true"
  # Custom policies directory
  policy.bundle.oci: ""
  policy.bundle.insecure: "false"
---
# ScannerReport for Open Forge namespaces
# Configures what to scan and how often
apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-scan-config
  namespace: trivy-system
  labels:
    app.kubernetes.io/name: trivy-operator
    app.kubernetes.io/component: scan-config
    app.kubernetes.io/part-of: open-forge-security
data:
  # Namespaces to include in scanning
  scanJob.podTemplateLabels: "app.kubernetes.io/managed-by=trivy-operator"
  # Scanner mode
  vulnerabilityReports.scanner: "Trivy"
  configAuditReports.scanner: "Trivy"
  # Scan schedule (cron format)
  # Leave empty for on-demand only, or set to schedule regular scans
  scanJob.schedule: "0 1 * * *"  # Daily at 1 AM
---
# VulnerabilityReport Example (generated by Trivy Operator)
# This is a sample of what Trivy generates - not applied directly
apiVersion: aquasecurity.github.io/v1alpha1
kind: VulnerabilityReport
metadata:
  name: example-vulnerability-report
  namespace: open-forge-prod
  labels:
    app.kubernetes.io/name: open-forge
    app.kubernetes.io/component: security-report
    trivy-operator.resource.kind: Deployment
    trivy-operator.resource.name: open-forge-api
    trivy-operator.container.name: api
  annotations:
    description: "Example vulnerability report structure"
spec:
  # This section is populated by Trivy Operator
  # Shown here for documentation purposes
  scanner:
    name: Trivy
    vendor: Aqua Security
    version: "0.48.0"
  registry:
    server: ghcr.io
  artifact:
    repository: 18bravo/open-forge-api
    tag: latest
  summary:
    criticalCount: 0
    highCount: 0
    mediumCount: 0
    lowCount: 0
    unknownCount: 0
  vulnerabilities: []
---
# ConfigAuditReport Example (generated by Trivy Operator)
apiVersion: aquasecurity.github.io/v1alpha1
kind: ConfigAuditReport
metadata:
  name: example-config-audit-report
  namespace: open-forge-prod
  labels:
    app.kubernetes.io/name: open-forge
    app.kubernetes.io/component: security-report
    trivy-operator.resource.kind: Deployment
    trivy-operator.resource.name: open-forge-api
  annotations:
    description: "Example config audit report structure"
spec:
  scanner:
    name: Trivy
    vendor: Aqua Security
    version: "0.48.0"
  summary:
    criticalCount: 0
    highCount: 0
    mediumCount: 0
    lowCount: 0
---
# ClusterComplianceReport for overall compliance
apiVersion: aquasecurity.github.io/v1alpha1
kind: ClusterComplianceReport
metadata:
  name: open-forge-compliance
  labels:
    app.kubernetes.io/name: open-forge
    app.kubernetes.io/component: security-report
    app.kubernetes.io/part-of: open-forge-security
  annotations:
    description: "Cluster-wide compliance report"
spec:
  # Compliance specifications based on standards
  cron: "0 2 * * *"  # Daily at 2 AM
  reportType: summary
  compliance:
    # NSA/CISA Kubernetes Hardening Guide
    - id: nsa
      title: NSA/CISA Kubernetes Hardening Guide
      description: Security best practices from NSA/CISA
      version: "1.0"
---
# Prometheus ServiceMonitor for Trivy Operator metrics
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: trivy-operator
  namespace: monitoring
  labels:
    app.kubernetes.io/name: trivy-operator
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: open-forge-security
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: trivy-operator
  namespaceSelector:
    matchNames:
      - trivy-system
  endpoints:
    - port: metrics
      interval: 60s
      path: /metrics
---
# PrometheusRule for Trivy alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: trivy-operator-alerts
  namespace: monitoring
  labels:
    app.kubernetes.io/name: trivy-operator
    app.kubernetes.io/component: alerts
    app.kubernetes.io/part-of: open-forge-security
spec:
  groups:
    - name: trivy.rules
      rules:
        - alert: CriticalVulnerabilityDetected
          expr: |
            sum by (namespace, name, container) (
              trivy_image_vulnerabilities{severity="Critical"}
            ) > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Critical vulnerability detected in {{ $labels.namespace }}/{{ $labels.name }}"
            description: "Container {{ $labels.container }} has {{ $value }} critical vulnerabilities"
            runbook_url: "https://docs.open-forge.io/runbooks/critical-vulnerability"

        - alert: HighVulnerabilityCount
          expr: |
            sum by (namespace, name, container) (
              trivy_image_vulnerabilities{severity="High"}
            ) > 5
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "High vulnerability count in {{ $labels.namespace }}/{{ $labels.name }}"
            description: "Container {{ $labels.container }} has {{ $value }} high vulnerabilities"

        - alert: ConfigAuditFailure
          expr: |
            sum by (namespace, name) (
              trivy_resource_configaudits{severity="Critical"}
            ) > 0
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Configuration audit failure in {{ $labels.namespace }}/{{ $labels.name }}"
            description: "Resource has critical configuration issues"

        - alert: ExposedSecretDetected
          expr: |
            sum by (namespace, name, container) (
              trivy_image_exposedsecrets
            ) > 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Exposed secret detected in {{ $labels.namespace }}/{{ $labels.name }}"
            description: "Container {{ $labels.container }} has exposed secrets in the image"
---
# Grafana Dashboard ConfigMap for Trivy
apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "true"
    app.kubernetes.io/name: trivy-operator
    app.kubernetes.io/component: dashboard
    app.kubernetes.io/part-of: open-forge-security
data:
  trivy-dashboard.json: |
    {
      "annotations": {
        "list": []
      },
      "description": "Trivy Operator Security Dashboard",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "title": "Critical Vulnerabilities by Namespace",
          "type": "stat",
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
          "targets": [
            {
              "expr": "sum by (namespace) (trivy_image_vulnerabilities{severity=\"Critical\"})",
              "legendFormat": "{{namespace}}"
            }
          ]
        },
        {
          "title": "Vulnerabilities by Severity",
          "type": "piechart",
          "gridPos": {"h": 8, "w": 8, "x": 6, "y": 0},
          "targets": [
            {
              "expr": "sum by (severity) (trivy_image_vulnerabilities)",
              "legendFormat": "{{severity}}"
            }
          ]
        },
        {
          "title": "Config Audit Issues",
          "type": "table",
          "gridPos": {"h": 8, "w": 10, "x": 14, "y": 0},
          "targets": [
            {
              "expr": "sum by (namespace, name, severity) (trivy_resource_configaudits) > 0",
              "format": "table"
            }
          ]
        }
      ],
      "refresh": "5m",
      "schemaVersion": 38,
      "tags": ["security", "trivy", "vulnerabilities"],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-24h",
        "to": "now"
      },
      "title": "Open Forge Security - Trivy",
      "uid": "trivy-security"
    }
