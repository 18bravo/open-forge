# Kustomize development overlay for Open Forge
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: open-forge-dev

# Reference base configuration
resources:
  - ../../base

# Target development namespace
namespace: open-forge-dev

# Development-specific labels
commonLabels:
  environment: development

# Development annotations
commonAnnotations:
  app.kubernetes.io/environment: development

# Replicas for development (reduced)
replicas:
  - name: open-forge-api
    count: 1
  - name: open-forge-ui
    count: 1
  - name: dagster-webserver
    count: 1
  - name: langflow
    count: 1

# Development images (use latest for dev)
images:
  - name: ghcr.io/18bravo/open-forge-api
    newTag: dev
  - name: ghcr.io/18bravo/open-forge-ui
    newTag: dev
  - name: ghcr.io/18bravo/open-forge-dagster
    newTag: dev

# ConfigMap customization for development
configMapGenerator:
  - name: open-forge-kustomize-config
    behavior: merge
    literals:
      - ENVIRONMENT=development
      - LOG_LEVEL=DEBUG

# Patches for development environment
patches:
  # Reduce API resources for development
  - target:
      kind: Deployment
      name: open-forge-api
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 100m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 256Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi

  # Reduce UI resources for development
  - target:
      kind: Deployment
      name: open-forge-ui
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 50m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 128Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 250m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 512Mi

  # Reduce Dagster resources for development
  - target:
      kind: Deployment
      name: dagster-webserver
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 100m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 256Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 1Gi

  # Reduce Langflow resources for development
  - target:
      kind: Deployment
      name: langflow
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 250m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 512Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: 2Gi

  # Reduce PostgreSQL storage for development
  - target:
      kind: StatefulSet
      name: postgres
    patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/resources/requests/storage
        value: 10Gi

  # Reduce Redis storage for development
  - target:
      kind: PersistentVolumeClaim
      name: redis-data
    patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 2Gi

  # Reduce MinIO storage for development
  - target:
      kind: StatefulSet
      name: minio
    patch: |-
      - op: replace
        path: /spec/volumeClaimTemplates/0/spec/resources/requests/storage
        value: 20Gi

  # Update API ingress for development
  - target:
      kind: Ingress
      name: open-forge-api
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: api.dev.open-forge.io
      - op: replace
        path: /spec/tls/0/hosts/0
        value: api.dev.open-forge.io

  # Update UI ingress for development
  - target:
      kind: Ingress
      name: open-forge-ui
    patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: dev.open-forge.io
      - op: remove
        path: /spec/rules/1
      - op: replace
        path: /spec/tls/0/hosts/0
        value: dev.open-forge.io
      - op: remove
        path: /spec/tls/0/hosts/1

  # Disable HPA in development
  - target:
      kind: HorizontalPodAutoscaler
    patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: not-used

  # Disable PDB in development
  - target:
      kind: PodDisruptionBudget
    patch: |-
      $patch: delete
      apiVersion: policy/v1
      kind: PodDisruptionBudget
      metadata:
        name: not-used
