# ServiceMonitors for Database Services
# PostgreSQL, Redis, and MinIO
# Requires Prometheus Operator to be installed

---
# PostgreSQL ServiceMonitor (via postgres_exporter)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: postgresql
  namespace: open-forge
  labels:
    app.kubernetes.io/name: postgresql
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: open-forge
    prometheus: main
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: postgres-exporter
  namespaceSelector:
    matchNames:
      - open-forge
  endpoints:
    - port: metrics
      path: /metrics
      interval: 30s
      scrapeTimeout: 15s
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - action: replace
          targetLabel: service
          replacement: postgresql
        - action: replace
          targetLabel: database
          replacement: open-forge
  targetLabels:
    - app.kubernetes.io/name
---
# Redis ServiceMonitor (via redis_exporter)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: redis
  namespace: open-forge
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
    app.kubernetes.io/part-of: open-forge
    prometheus: main
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: redis-exporter
  namespaceSelector:
    matchNames:
      - open-forge
  endpoints:
    - port: metrics
      path: /metrics
      interval: 15s
      scrapeTimeout: 10s
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - action: replace
          targetLabel: service
          replacement: redis
  targetLabels:
    - app.kubernetes.io/name
---
# MinIO ServiceMonitor
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: minio
  namespace: open-forge
  labels:
    app.kubernetes.io/name: minio
    app.kubernetes.io/component: object-storage
    app.kubernetes.io/part-of: open-forge
    prometheus: main
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: minio
  namespaceSelector:
    matchNames:
      - open-forge
  endpoints:
    - port: metrics
      path: /minio/v2/metrics/cluster
      interval: 30s
      scrapeTimeout: 15s
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: node
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: namespace
        - action: replace
          targetLabel: service
          replacement: minio
    # Bucket metrics endpoint
    - port: metrics
      path: /minio/v2/metrics/bucket
      interval: 60s
      scrapeTimeout: 30s
      scheme: http
      honorLabels: true
      relabelings:
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: pod
        - action: replace
          targetLabel: service
          replacement: minio
  targetLabels:
    - app.kubernetes.io/name
---
# PrometheusRule for Database SLOs
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: database-rules
  namespace: open-forge
  labels:
    app.kubernetes.io/name: databases
    prometheus: main
    role: alert-rules
spec:
  groups:
    - name: database.slo
      interval: 30s
      rules:
        # PostgreSQL availability
        - record: postgresql:availability:1h
          expr: avg_over_time(pg_up[1h])

        # PostgreSQL query latency
        - record: postgresql:query_duration:p95
          expr: |
            histogram_quantile(0.95,
              sum(rate(pg_stat_statements_seconds_bucket[5m])) by (le)
            )

        # Redis availability
        - record: redis:availability:1h
          expr: avg_over_time(redis_up[1h])

        # Redis hit rate
        - record: redis:hit_rate:5m
          expr: |
            rate(redis_keyspace_hits_total[5m])
            /
            (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))

        # MinIO availability
        - record: minio:availability:1h
          expr: avg_over_time(minio_cluster_health_status[1h])

        # MinIO storage utilization
        - record: minio:storage_utilization
          expr: |
            1 - (minio_cluster_disk_free_bytes / minio_cluster_disk_total_bytes)

    - name: database.capacity
      interval: 60s
      rules:
        # PostgreSQL connection capacity
        - record: postgresql:connection_capacity
          expr: |
            1 - (pg_stat_activity_count / pg_settings_max_connections)

        # Redis memory capacity
        - record: redis:memory_capacity
          expr: |
            1 - (redis_memory_used_bytes / redis_memory_max_bytes)

        # MinIO disk capacity
        - record: minio:disk_capacity
          expr: |
            minio_cluster_disk_free_bytes / minio_cluster_disk_total_bytes
